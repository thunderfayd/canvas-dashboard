<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canvas AI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.13.0/cdn.js" defer></script>
    <style>
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .gradient-bg {
            background: linear-gradient(-45deg, #667eea, #764ba2, #f093fb, #4facfe);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .assignment-card {
            transition: all 0.3s ease;
        }
        
        .assignment-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen text-white" x-data="canvasApp()">
    <!-- Header -->
    <header class="glass sticky top-0 z-50 px-6 py-4">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                </svg>
                <h1 class="text-2xl font-bold">Canvas AI Assistant</h1>
            </div>
            <button @click="showSettings = !showSettings" class="p-2 rounded-lg hover:bg-white/20 transition">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
            </button>
        </div>
    </header>

    <!-- Settings Modal -->
    <div x-show="showSettings" x-transition class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50" @click.self="showSettings = false">
        <div class="glass rounded-2xl p-6 max-w-md w-full fade-in" @click.stop>
            <h2 class="text-xl font-bold mb-4">Settings</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm mb-2">Canvas URL</label>
                    <input type="text" x-model="canvasUrl" placeholder="https://uwm.instructure.com" 
                           class="w-full px-4 py-2 rounded-lg bg-white/20 border border-white/30 focus:outline-none focus:border-white">
                </div>
                <div>
                    <label class="block text-sm mb-2">API Token</label>
                    <input type="password" x-model="apiToken" placeholder="Your Canvas API token" 
                           class="w-full px-4 py-2 rounded-lg bg-white/20 border border-white/30 focus:outline-none focus:border-white">
                </div>
                <div>
                    <label class="block text-sm mb-2">AI Provider (Optional)</label>
                    <select x-model="aiProvider" class="w-full px-4 py-2 rounded-lg bg-white/20 border border-white/30 focus:outline-none focus:border-white">
                        <option value="none">None (Basic features only)</option>
                        <option value="groq">Groq (Free)</option>
                        <option value="cohere">Cohere (Free tier)</option>
                    </select>
                </div>
                <button @click="saveSettings" class="w-full py-2 bg-white/20 hover:bg-white/30 rounded-lg transition">
                    Save Settings
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-6 py-8">
        <!-- Quick Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="glass rounded-xl p-6 fade-in">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-sm opacity-80">Active Courses</h3>
                    <svg class="w-5 h-5 opacity-60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                    </svg>
                </div>
                <p class="text-3xl font-bold" x-text="stats.courses">-</p>
            </div>
            
            <div class="glass rounded-xl p-6 fade-in" style="animation-delay: 0.1s">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-sm opacity-80">Due This Week</h3>
                    <svg class="w-5 h-5 opacity-60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <p class="text-3xl font-bold" x-text="stats.dueThisWeek">-</p>
            </div>
            
            <div class="glass rounded-xl p-6 fade-in" style="animation-delay: 0.2s">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-sm opacity-80">Average Grade</h3>
                    <svg class="w-5 h-5 opacity-60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <p class="text-3xl font-bold" x-text="stats.avgGrade + '%'">-%</p>
            </div>
            
            <div class="glass rounded-xl p-6 fade-in" style="animation-delay: 0.3s">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-sm opacity-80">Upcoming</h3>
                    <svg class="w-5 h-5 opacity-60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                </div>
                <p class="text-3xl font-bold" x-text="stats.totalUpcoming">-</p>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="glass rounded-xl p-1 mb-6 inline-flex">
            <button @click="activeTab = 'assignments'" 
                    :class="activeTab === 'assignments' ? 'bg-white/20' : ''"
                    class="px-4 py-2 rounded-lg transition">
                Assignments
            </button>
            <button @click="activeTab = 'courses'" 
                    :class="activeTab === 'courses' ? 'bg-white/20' : ''"
                    class="px-4 py-2 rounded-lg transition">
                Courses
            </button>
            <button @click="activeTab = 'ai'" 
                    :class="activeTab === 'ai' ? 'bg-white/20' : ''"
                    class="px-4 py-2 rounded-lg transition">
                AI Assistant
            </button>
        </div>

        <!-- Content Area -->
        <div x-show="activeTab === 'assignments'" class="space-y-4">
            <template x-for="assignment in upcomingAssignments" :key="assignment.id">
                <div class="glass rounded-xl p-6 assignment-card">
                    <div class="flex items-start justify-between">
                        <div>
                            <h3 class="text-xl font-semibold mb-1" x-text="assignment.name"></h3>
                            <p class="opacity-80 mb-2" x-text="assignment.course_name"></p>
                            <div class="flex items-center space-x-4 text-sm">
                                <span class="flex items-center">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    <span x-text="formatDate(assignment.due_at)"></span>
                                </span>
                                <span x-show="assignment.points_possible" class="flex items-center">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                                    </svg>
                                    <span x-text="assignment.points_possible + ' points'"></span>
                                </span>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="inline-block px-3 py-1 rounded-full text-sm"
                                  :class="getDaysUntilDue(assignment.due_at) <= 1 ? 'bg-red-500/20 text-red-100' : 
                                         getDaysUntilDue(assignment.due_at) <= 3 ? 'bg-yellow-500/20 text-yellow-100' : 
                                         'bg-green-500/20 text-green-100'">
                                <span x-text="getDaysUntilDue(assignment.due_at) + ' days'"></span>
                            </span>
                        </div>
                    </div>
                </div>
            </template>
        </div>

        <div x-show="activeTab === 'courses'" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <template x-for="course in courses" :key="course.id">
                <div class="glass rounded-xl p-6 assignment-card">
                    <h3 class="text-xl font-semibold mb-2" x-text="course.name"></h3>
                    <div class="space-y-2 text-sm opacity-80">
                        <p x-text="'Course Code: ' + course.course_code"></p>
                        <p x-show="course.enrollments && course.enrollments[0]">
                            Current Grade: <span x-text="course.enrollments[0].computed_current_grade || 'N/A'"></span>
                        </p>
                    </div>
                </div>
            </template>
        </div>

        <div x-show="activeTab === 'ai'" class="space-y-6">
            <div class="glass rounded-xl p-6">
                <h3 class="text-xl font-semibold mb-4">AI Study Assistant</h3>
                <div class="space-y-4">
                    <button @click="generateStudyPlan" class="w-full py-3 bg-white/20 hover:bg-white/30 rounded-lg transition flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                        </svg>
                        Generate Study Plan
                    </button>
                    
                    <button @click="summarizeAnnouncements" class="w-full py-3 bg-white/20 hover:bg-white/30 rounded-lg transition flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"></path>
                        </svg>
                        Summarize Announcements
                    </button>
                </div>
                
                <div x-show="aiResponse" class="mt-6 p-4 bg-white/10 rounded-lg">
                    <p x-text="aiResponse" class="whitespace-pre-wrap"></p>
                </div>
            </div>
        </div>
    </main>

    <script>
        function canvasApp() {
            return {
                showSettings: false,
                activeTab: 'assignments',
                canvasUrl: localStorage.getItem('canvasUrl') || '',
                apiToken: localStorage.getItem('apiToken') || '',
                aiProvider: localStorage.getItem('aiProvider') || 'none',
                aiResponse: '',
                courses: [],
                upcomingAssignments: [],
                stats: {
                    courses: 0,
                    dueThisWeek: 0,
                    avgGrade: 0,
                    totalUpcoming: 0
                },
                
                init() {
                    if (this.apiToken) {
                        this.loadData();
                    } else {
                        this.showSettings = true;
                    }
                },
                
                saveSettings() {
                    localStorage.setItem('canvasUrl', this.canvasUrl);
                    localStorage.setItem('apiToken', this.apiToken);
                    localStorage.setItem('aiProvider', this.aiProvider);
                    this.showSettings = false;
                    this.loadData();
                },
                
                async loadData() {
                    try {
                        // Your Vercel backend URL
                       const API_URL = 'https://resplendent-sundae-1d473a.netlify.app';
                        
                        // Fetch courses
                       const coursesResponse = await fetch(
    `${API_URL}/canvas?endpoint=courses`, 
    {
        headers: { 
            'Authorization': `Bearer ${this.apiToken}` 
        }
    }
);
                        
                        if (coursesResponse.ok) {
                            this.courses = await coursesResponse.json();
                            
                             console.log('Courses received:', this.courses.length, this.courses);
                            // Right after: this.courses = await coursesResponse.json();
console.log('Courses received:', this.courses.length, this.courses);

// ADD THIS NEW DEBUG SECTION:
// Try to fetch ALL enrollments
const enrollmentsResponse = await fetch(
    `${API_URL}/api/canvas?endpoint=users/self/enrollments&per_page=100`, 
    {
        headers: { 
            'Authorization': `Bearer ${this.apiToken}` 
        }
    }
);

if (enrollmentsResponse.ok) {
    const enrollments = await enrollmentsResponse.json();
    console.log('All enrollments:', enrollments.length, enrollments);
    console.log('Unique courses from enrollments:', 
        [...new Set(enrollments.map(e => e.course_id))].length
    );
}
                            // Fetch all assignments
                            this.upcomingAssignments = [];
                            for (const course of this.courses) {
                                const assignmentsResponse = await fetch(
                                    `${API_URL}/api/canvas?endpoint=courses/${course.id}/assignments`,
                                    {
                                        headers: { 
                                            'Authorization': `Bearer ${this.apiToken}` 
                                        }
                                    }
                                );
                                
                                if (assignmentsResponse.ok) {
                                    const assignments = await assignmentsResponse.json();
                                    // Add course name to each assignment
                                    assignments.forEach(assignment => {
                                        assignment.course_name = course.name;
                                        if (assignment.due_at) {
                                            this.upcomingAssignments.push(assignment);
                                        }
                                    });
                                }
                            }
                            
                            // Sort by due date
                            this.upcomingAssignments.sort((a, b) => 
                                new Date(a.due_at) - new Date(b.due_at)
                            );
                        }
                        
                        this.updateStats();
                    } catch (error) {
                        console.error('Error loading Canvas data:', error);
                        // Fall back to mock data if there's an error
                        this.courses = [
                            { id: 1, name: 'Photography: Critical Introduction', course_code: 'PHOTO 201', enrollments: [{computed_current_grade: 'A-'}] },
                            { id: 2, name: 'Microeconomics', course_code: 'ECON 103', enrollments: [{computed_current_grade: 'B+'}] }
                        ];
                        
                        this.upcomingAssignments = [
                            {
                                id: 1,
                                name: 'Weekly Photo Assignment - Modernism',
                                course_name: 'Photography: Critical Introduction',
                                due_at: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000).toISOString(),
                                points_possible: 100
                            }
                        ];
                        
                        this.updateStats();
                    }
                },
                
                updateStats() {
                    this.stats.courses = this.courses.length;
                    this.stats.totalUpcoming = this.upcomingAssignments.length;
                    
                    const oneWeekFromNow = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000);
                    this.stats.dueThisWeek = this.upcomingAssignments.filter(a => 
                        new Date(a.due_at) <= oneWeekFromNow
                    ).length;
                    
                    // Calculate average grade (mock)
                    this.stats.avgGrade = 88;
                },
                
                formatDate(dateString) {
                    const date = new Date(dateString);
                    return date.toLocaleDateString('en-US', { 
                        weekday: 'short', 
                        month: 'short', 
                        day: 'numeric',
                        hour: 'numeric',
                        minute: '2-digit'
                    });
                },
                
                getDaysUntilDue(dateString) {
                    const due = new Date(dateString);
                    const now = new Date();
                    const days = Math.ceil((due - now) / (1000 * 60 * 60 * 24));
                    return days;
                },
                
                async generateStudyPlan() {
                    this.aiResponse = "Loading...";
                    
                    // For free AI, you could use Groq or Cohere's free tier
                    // This is a mock response
                    setTimeout(() => {
                        this.aiResponse = `üìÖ Study Plan for This Week:

Monday (Today):
‚Ä¢ 2:00-4:00 PM: Start Photography assignment
  - Review modernism chapter in Wells textbook
  - Search for suitable photographs online

Wednesday:
‚Ä¢ 3:00-5:00 PM: Complete Photography assignment
  - Write 300-word analysis
  - Format and submit before Friday deadline

Thursday:
‚Ä¢ 6:00-8:00 PM: Begin Economics problem set
  - Review supply/demand curves
  - Complete first 3 problems

Saturday:
‚Ä¢ 10:00 AM-12:00 PM: Finish Economics problem set
  - Double-check calculations
  - Submit with time to spare

üí° Tips:
- Photography due Friday 11:59 PM - don't wait until last minute!
- Economics problems build on each other - do them in order
- Take breaks every 45-50 minutes for better focus`;
                    }, 1000);
                },
                
                async summarizeAnnouncements() {
                    this.aiResponse = "Loading announcements...";
                    
                    setTimeout(() => {
                        this.aiResponse = `üì¢ Recent Announcements Summary:

Photography Course:
‚Ä¢ Assignment clarification: For this week's modernism theme, focus on photographers from 1920s-1940s
‚Ä¢ Office hours moved to Thursday 2-4 PM
‚Ä¢ Guest speaker next Tuesday on documentary photography

Economics Course:
‚Ä¢ Midterm exam scheduled for March 15th
‚Ä¢ Chapter 5 (Elasticity) readings now available
‚Ä¢ Problem set solutions will be posted after submission deadline

‚ö†Ô∏è Important Deadlines:
‚Ä¢ Photo assignment: Friday 11:59 PM
‚Ä¢ Econ problem set: Next Tuesday
‚Ä¢ Spring break trip deposit: March 1st`;
                    }, 1000);
                }
            }
        }
    </script>
</body>
</html>
